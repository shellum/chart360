<!DOCTYPE html>
<html>

<head>
  <script>
    var overallMargin = 10;
    var embeddedYMargin = 25;
    var textMargin = 10;
    var overallWidth = 800;
    var overallHeight = 100;
    var extraTextSpacing = 5;
    var outerColor = "#0000aa";
    var gradientOuterColor = "rgb(0,180,240)";
    var gradientInnerColor = "rgb(77,255,255)"
    var textColor = "#444444";
    var managerColor = "rgb(0,180,0)";
    var selfColor = "rgb(108,108,108)";
    var maxI = 10;
    var fontSize = 15;
    var attribute = "";

    function draw(_attribute) {
       attribute = _attribute;
       rect(overallMargin,overallMargin,0, overallWidth,overallHeight,outerColor,false);
       var peerAverage = getPeerAverage();
       console.log("peerAverage: " + peerAverage);
       console.log("peerMin: " + getPeerLow());
       console.log("peerMax: " + getPeerHigh());
       var peerLowCoordinate = getNumericMargin(peerAverage);
       console.log("peerMargin is " + peerLowCoordinate);
       var xMargin = 0;
       var yMargin = overallMargin + embeddedYMargin
       var xOffset = getNumericMargin(getPeerLow()) + fontSize/3;
       var width = getNumericMargin(getPeerHigh()) - getNumericMargin(getPeerLow());
       if (width == 0) {
         xOffset = getNumericMargin(getPeerLow() - 0.2) + fontSize/3;
         width = getNumericMargin(getPeerHigh() + 0.2) - getNumericMargin(getPeerLow() - 0.2);
       }
       var height = 30;
       rect(xMargin, yMargin, xOffset, width, height, "", true);
       text();
       drawMarkerLine(getManagerRating(),managerColor,0);
       drawMarkerLine(getSelfRating(),selfColor,55);

    }

    function drawMarkerLine(rating,color,y) {
      var x = getNumericMargin(rating) + fontSize/3;
      console.log("managerRating: " + rating);
      var canvas = document.getElementById(attribute + "Canvas");
      if (canvas.getContext) {
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        if (y != 0) y-=(overallMargin+10);
        ctx.moveTo(x, overallMargin + 10 + y);
        ctx.lineTo(x, y+45);
        console.log("plotting: " + (overallMargin + 10 + y) + " to " + (y+45) );
        ctx.stroke();
      }
    }

    function getManagerRating() {
      var managerRating = document.getElementById(attribute + "ManagerRating").value;
      return parseInt(managerRating);
    }

    function getSelfRating() {
      var selfRating = document.getElementById(attribute + "SelfRating").value;
      return parseInt(selfRating);
    }

    function getPeerAverage() {
      var peerValues = document.getElementById(attribute + "PeerRatings").value;
      var peerArray = peerValues.split(",");
      var total = 0.0;
      peerArray.map(function(peerValue) {
        total += parseFloat(peerValue);
      });
      return (total / peerArray.length).toFixed(1);
    }

    function getPeerHigh() {
      var peerValues = document.getElementById(attribute + "PeerRatings").value;
      var peerArray = peerValues.split(",");
      return Math.max.apply(Math, peerArray);
    }

    function getPeerLow() {
      var peerValues = document.getElementById(attribute + "PeerRatings").value;
      var peerArray = peerValues.split(",");
      return Math.min.apply(Math, peerArray);
    }

    function text() {
      var canvas = document.getElementById(attribute + "Canvas");
      if (canvas.getContext) {
        var ctx = canvas.getContext("2d");
        ctx.fillStyle=textColor;
        ctx.font=fontSize + "px Helvetica";
        for(var i=1;i<=maxI;i++) {
          ctx.fillText(i,getNumericMargin(i),overallHeight);
          console.log("writing " + i + " at " + getNumericMargin(i));
        }
        ctx.fillText(attribute,getNumericMargin(1),overallMargin+embeddedYMargin);
      }
    }

    function getNumericMargin(i) {
      return overallMargin+textMargin+(i-1)*((overallWidth/maxI)+extraTextSpacing);
    }

    function rect(xMargin,yMargin,x, width,height,color,fill) {
      console.log("rect at " + (xMargin+x) + " , " + width+", " + height);
      var canvas = document.getElementById(attribute + "Canvas");
      if (canvas.getContext) {
        var ctx = canvas.getContext("2d");

        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        if (fill) {
          var gradient = ctx.createLinearGradient(xMargin+x, yMargin, xMargin+x+width, yMargin+height);

          // x  ave - low
          // -  ---------
          // 1  high - low

          var colorSpikeStop = (getPeerAverage() - getPeerLow()) / (getPeerHigh() - getPeerLow());
          if (isNaN(colorSpikeStop)) colorSpikeStop = 0.5;

          gradient.addColorStop(0, gradientOuterColor);
          gradient.addColorStop(colorSpikeStop, gradientInnerColor);
          gradient.addColorStop(1.0, gradientOuterColor);

          ctx.fillStyle = gradient;
          ctx.fillRect (xMargin+x,yMargin,width,height);
        }
        else {
          ctx.strokeRect (xMargin+x,yMargin,width,height);
        }
      }
    }
    function addControls(_attribute) {
      var br = document.createElement("br");
      var peerRatingsBox = document.createElement("input");
      peerRatingsBox.setAttribute("type","text");
      peerRatingsBox.setAttribute("id",_attribute+"PeerRatings")
      var peerRatingsDesc = document.createTextNode(_attribute+" - Peer Ratings (CSV):");

      var managerRatingBox = document.createElement("input");
      managerRatingBox.setAttribute("type","text");
      managerRatingBox.setAttribute("id",_attribute+"ManagerRating")
      var managerRatingDesc = document.createTextNode(_attribute+" - Manager Rating:");

      var selfRatingBox = document.createElement("input");
      selfRatingBox.setAttribute("type","text");
      selfRatingBox.setAttribute("id",_attribute+"SelfRating")
      var selfRatingDesc = document.createTextNode(_attribute+" - Self Rating:");

      var canvas = document.createElement("canvas");
      canvas.setAttribute("width","1100");
      canvas.setAttribute("height","150");
      canvas.setAttribute("id",_attribute + "Canvas");

      var controlMarker = document.getElementById("controlMarker");
      var canvasMarker = document.getElementById("canvasMarker");
      document.body.insertBefore(peerRatingsDesc, controlMarker);
      document.body.insertBefore(peerRatingsBox, controlMarker);
      document.body.insertBefore(document.createElement("br"), controlMarker);
      document.body.insertBefore(managerRatingDesc, controlMarker);
      document.body.insertBefore(managerRatingBox, controlMarker);
      document.body.insertBefore(document.createElement("br"), controlMarker);
      document.body.insertBefore(selfRatingDesc, controlMarker);
      document.body.insertBefore(selfRatingBox, controlMarker);
      document.body.insertBefore(document.createElement("br"), controlMarker);
      document.body.insertBefore(canvas,canvasMarker);
    }
    var types=['Is Kind','Helps','Codes Cleanly','Tests','Automates','Iterates'];
  </script>
</head>

<body onload="types.map(function(t) {addControls(t);});">
  <div id="controlMarker"></div>
  <button onclick="types.map(function(t) {draw(t);});">Draw</button><br/>
  <div id="canvasMarker"></div>
  <canvas id="kindCanvas" width="1100" height="150"></canvas>
  <br/><br/>
  <canvas id="helpfulCanvas" width="1100" height="150"></canvas>
  <br/><br/>
</body>

</html>
